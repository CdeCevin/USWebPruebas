<!DOCTYPE html>
{% extends 'core/base_brigade.html' %}
{%load static %}
{% block content %}
<body id="page-top">       
    <div class="content container-fluid">
        <div class="page-header">
            <div class="row">
                <div class="col-sm-12">
                    <h3 class="page-title">Solicitud en Proceso</h3>
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item active"><a href="{% url 'cuadrilla_main' %}">Inicio</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'brigade_list_progress' %}">Solicitudes en Proceso</a></li>
                        <li class="breadcrumb-item active">Ver Solicitud</li>
                    </ul>
                </div>
            </div>
        </div>                
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">        
                        <div class="row">
                            <div class="col-md-6">
                                <h4 class="card-title ">Título</h4>
                                <div class="form-group">
                                    <input type="text" class="form-control" name="poll_name" value="{{poll_data.name}}" disabled>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h4 class="card-title ">Tipo Incidencia</h4>
                                <div class="form-group">
                                    <input type="text" class="form-control" name="poll_name" value="{{poll_data.incident}}" disabled>
                                </div>
                            </div>
                        </div>
                        <br> 
                        <h4 class="card-title">Información Personal</h4>
                        <div class="row">
                            <div class="col-md-6">
                                {% for field_name, field_value in field_answer_pairs %}
                                    {% if field_name == 'name_neighbor' %}
                                        <div class="form-group">
                                            <label>Nombre Vecino</label>
                                            <input type="text" class="form-control" name="{{ field_name }}" value="{{ field_value }}" disabled>
                                        </div>
                                    {% elif field_name == 'mail_neighbor' %}
                                        <div class="form-group">
                                            <label>Email</label>
                                            <input type="text" class="form-control" name="{{ field_name }}" value="{{ field_value }}" disabled>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <div class="col-md-6">
                                {% for field_name, field_value in field_answer_pairs %}
                                    {% if field_name == 'pohne_neighbor' %}
                                        <div class="form-group">
                                            <label>Teléfono</label>
                                            <input type="text" class="form-control" name="{{ field_name }}" value=" {{ field_value }}" disabled>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <div class="col-md-6">
                                {% for field_name, field_value in field_answer_pairs %}
                                    {% if field_name == 'rut_neighbor' %}
                                        <div class="form-group">
                                            <label>Rut</label>
                                            <input type="text" class="form-control" name="{{ field_name }}" value=" {{ field_value }}" disabled>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        <h4 class="card-title mt-4">Información Incidente</h4>
                        <div class="row">
                            <div class="col-md-6">
                                {% for field_name, field_value in field_answer_pairs %}
                                    {% if field_name == 'incidence_classification' %}
                                        <div class="form-group">
                                            <label>Clasificación incidencia</label>
                                            <input type="text" class="form-control" name="{{ field_name }}" value="{{ field_value }}" disabled>
                                        </div>
                                    {% elif field_name == 'incidence_priority' %}
                                        <div class="form-group">
                                            <label>Prioridad</label>
                                            <input type="text" class="form-control" name="{{ field_name }}" value="{{ field_value }}" disabled>
                                        </div>
                                    {% elif field_name == 'incidence_location' %}
                                        <div class="form-group">
                                            <label>Ubicación</label>
                                            <input type="text" class="form-control" name="{{ field_name }}" value="{{ field_value }}" disabled>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <div class="col-md-6">
                                {% for field_name, field_value in field_answer_pairs %}
                                    {% if field_name == 'incidence_description' %}
                                        <div class="form-group">
                                            <label>Descripción</label>
                                            <textarea rows="8" cols="5" class="form-control" name="{{ field_name }}" disabled>{{ field_value }}</textarea>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        <h4 class="card-title mt-4">Información Multimedia</h4>
                        <div class="row">
                            <div class="col-md-6">
                                {% for field_name, field_value in field_answer_pairs %}
                                    {% if field_name == 'incidence_image' %}
                                        <label>Imagen</label>
                                        <div class="row">                                                            
                                            {% for imagen in images %}
                                                <div class="col-md-4 mb-4">
                                                    <div class="card">
                                                        <img src="{{ imagen }}" alt="title">
                                                    </div>
                                                </div>
                                            {% endfor %}
                                           
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <div class="col-md-6">
                                {% for field_name, field_value in field_answer_pairs %}
                                    {% if field_name == 'incidence_video' %}
                                        <div class="form-group">
                                            <label>Video</label>
                                            {% if incidence_video != '' %}
                                                <video width="100%" height="240" controls>
                                                    <source src="{{incidence_video}}" type="video/mp4">
                                                    Tu navegador no soporta la etiqueta de video.
                                                </video> 
                                            {% else %}
                                                <p>El video no se cargó correctamente.</p>                                                                                                              
                                            {% endif %}                                                                
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                {% for field_name, field_value in field_answer_pairs %}
                                    {% if field_name == 'incidence_audio' %}
                                        <div class="form-group">
                                            <label>Audio</label>
                                            {% if field_value != '' %}
                                                <audio controls>
                                                    <source src="{{ incidence_audio }}" type="audio/mpeg">
                                                    Tu navegador no soporta la etiqueta de audio.
                                                </audio>
                                            {% else %}
                                                <p>El audio no se cargó correctamente.</p>                                                                                                              
                                            {% endif %}                                                         
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        <h4 class="card-title mt-4">Ubicación</h4>
                        <div class="row">
                            <div class="col-md-12">  
                                {% if lat != '' and lon != '' %}                                       
                                    <div id="map"></div>
                                {% else %}
                                    <p>Las coordenadas no se cargaron correctamente.</p>                                                    
                                {% endif %}
                            </div>
                        </div>                        
                        <div class="row mt-2">
                            <div class="col-md-3">
                                <!-- Botones para pantallas grandes (lg) y más grandes -->
                                <div class="form-group d-none d-lg-inline">
                                    <div class="d-flex justify-content-between">
                                        <button id="finishButton" class="btn btn-primary mx-2" style="min-width: 220px;">Agregar información</button>
                                        <a type="button" href="{% url 'brigade_list_progress' %}" class="btn btn-primary mx-2" style="min-width: 220px;">Volver</a>
                                        
                                    </div>
                                </div>
                                <!-- Botones para pantallas pequeñas (md) y más pequeñas -->
                                <div class="form-group d-lg-none mt-3 text-center">
                                    <a id="finishButton" href=# class="btn btn-primary d-inline-block mx-2 mb-2"style="min-width: 170px;" type="button">Agregar Información</a>
                                    <a class="btn btn-primary d-inline-block mx-2 mb-2"href="{% url 'brigade_list_progress' %}"style="min-width: 170px;" type="button" >Volver</a>
                                </div>
                            </div>
                        </div> 
                    </div>
                </div>
            </div>
        </div>          
        <div>
            <!-- Llamada del footer -->
            {% include 'core/footer.html' %}
        </div>
    </div>
</body>
    {% block scripts %}
    <script>
        function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
        }

        function showFinishSurveyAlert() {
            const csrftoken = getCookie('csrftoken');
            Swal.fire({
                title: 'Agregar Información Sobre Solicitud',
                html: `<form id="saveInformation">
                            <input type="text" class="form-control" name="request_id" id="request_id" value="{{request_id}}" hidden>
                            <div style="margin-bottom: 15px;">
                                <small class="form-text text-muted">Rellene esta información sólo cuando el trabajo esté terminado. <br>(Una vez guardada y finalizada la solicitud no se podrá volver a editar.)</small>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="incidentDescription" class="form-label">Descripción del Incidente:</label>
                                <input id="incidentDescription" type="text" name="incidentDescription" class="form-control" placeholder="Ingrese la descripción">
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label for="incidentImage" class="form-label">Imagen del Incidente:</label>
                                <small class="text-muted">Peso máximo 5 MB, tamaño máximo 1920x1080, formatos admitidos: JPG, PNG</small>
                                <div class="input-group">
                                    <input type="file" class="form-control d-none" id='incidentImage' name='incidentImage' multiple accept="image/*" onchange="updateFileCount(this, 'imageFileCountText')">
                                    <label class="input-group-text btn btn-upload" for="incidentImage">
                                        <i class="far fa-file-image"></i> Seleccionar Imagen
                                    </label>
                                </div>
                                <p id="imageFileCountText" class="text-muted mt-2"></p>
                            </div>
                        </form>`,
                showCancelButton: true,
                confirmButtonColor: '#134982',
                confirmButtonText: 'Guardar y Finalizar',
                cancelButtonText: 'Cancelar',
                didOpen: () => {
                    const incidentImage = document.getElementById('incidentImage');
                },
                preConfirm: () => {
                    const form = document.getElementById('saveInformation');
                    const formData = new FormData(form);
                    return Swal.fire({
                        title: '¿Estás seguro que quieres Guardar y Finalizar?',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#134982',
                        confirmButtonText: 'Sí',
                        cancelButtonText: 'No',
                    }).then((result) => {
                        if (result.isConfirmed) {
                            return fetch("{% url 'brigade_alert' %}", { 
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': csrftoken
                                },
                                body: formData
                            }).then(response => {
                                if (!response.ok) {
                                    throw new Error('Error en la solicitud al backend');
                                }
                                return response.json();
                            }).then(data => {
                                if (data.status === 'success') {
                                    window.location.href = "{% url 'cuadrilla_main' %}";
                                } else {
                                    Swal.showValidationMessage(`Request failed: ${data.message}`);
                                }
                            }).catch(error => {
                                console.log(`Request failed: ${error}`);
                                Swal.showValidationMessage(`Request failed: ${error}`);
                            });
                        } else {
                            showErrorAlert();
                            return false;
                        }
                    });
                }
            });
        }

    function updateFileCount(input, textElementId) {
        const count = input.files.length;
        const textElement = document.getElementById(textElementId);
        if (count === 0) {
            textElement.textContent = 'No se seleccionó ningún archivo.';
        } else {                
            textElement.textContent = `${count} archivo(s) seleccionado(s).`;
        }
    }

    function showSuccessAlert() {
        Swal.fire({
            title: 'Solicitud Guardada y Finalizada Correctamente',
            icon: 'success',
            confirmButtonColor: '#134982',
            confirmButtonText: 'Aceptar',
        });
    }

    function showErrorAlert() {
        Swal.fire({
            title: 'Cancelado',
            text: 'Se canceló la acción correctamente',
            icon: 'info',
            confirmButtonColor: '#134982',
            confirmButtonText: 'Aceptar',
        });
    }

    function showCancelAlert() {
        Swal.fire({
            title: 'Solicitud cancelada',
            icon: 'info',
            confirmButtonColor: '#134982',
            confirmButtonText: 'Aceptar',
        });
        }

        $(document).ready(function () {
            $('#finishButton').on('click', function () {
                showFinishSurveyAlert();
            });
        });
    </script>

        <!-- funciones js -->
        <script>
            function initMap() {
                const ubicacion = { lat: {{ lat }}, lng: {{ lon }} };
                const map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 15,
                    center: ubicacion,
                });
                const marker = new google.maps.Marker({
                    position: ubicacion,
                    map: map,
                });
            }
        </script>
        <script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBuYuM-g2fRBcIyADL5lx65WBQbBrCDmKg&callback=initMap"></script>
    {% endblock %}
{% endblock %}
