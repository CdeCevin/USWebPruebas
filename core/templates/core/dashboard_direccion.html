<!DOCTYPE html>
{% extends 'core/base_direccion.html' %}
{%load static %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Tarjeta solicitudes abiertas -->
        <div class="col mb-4">
            <a href="{% url 'management_main' %}" class="text-decoration-none text-dark">
                <div class="card border-left-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                    Solicitudes Abiertas
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">{{request_star_count}}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-plus fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        <!-- Tarjeta solicitudes derivadas -->
        <div class="col mb-4">
            <a href="{% url 'management_list_derived' %}" class="text-decoration-none text-dark">
                <div class="card border-left-warning shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                    Solicitudes Derivadas</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">{{request_delivery_count}}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-inbox fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    
        <!-- Tarjeta solicitudes en proceso-->
        <div class="col mb-4">
            <a href="{% url 'management_in_progress' %}" class="text-decoration-none text-dark">
                <div class="card border-left-primary shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                    Solicitudes En Proceso</div>
                                <div class="h5 mb-0 mr-3 font-weight-bold text-gray-800">{{request_in_progress_count}}</div>
                                <div class="row no-gutters align-items-center">
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-spinner fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <!-- Tarjeta solicitudes finalizadas-->
        <div class="col mb-4">
            <a href="{% url 'management_finish' %}" class="text-decoration-none text-dark">
                <div class="card border-left-danger shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                    Solicitudes Finalizadas</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">{{request_finish_count}}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-check fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    
        <!-- Tarjeta solicitudes cerradas-->
        <div class="col mb-4">
            <a href="{% url 'management_list_closed' %}" class="text-decoration-none text-dark">
                <div class="card border-left-secondary shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">
                                    Solicitudes Cerradas</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">{{request_close_count}}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-check-double fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    </div>
    <br>
    </br>
<div class="container-fluid">
    <!-- Fila que contiene las dos tablas -->
    <div class="row">
        <!-- Primera tabla: Cuadrillas con más solicitudes atrasadas -->
        <div class="card shadow col-md-6">
            <div class="card-header">
                <h5 class="m-0 font-weight-bold text-primary">Cuadrillas con solicitudes Atrasadas</h5>
            </div>
            <table class="table table-bordered table-compact">
                <thead>
                    <tr>
                        <th>Tipo de Incidencia</th>
                        <th>Nombre Cuadrilla</th>
                        <th>Estado</th>
                        <th>Fecha</th>
                        <th>Detalle</th>
                    </tr>
                </thead>
                <tbody>
                    {% for solicitud in solicitudes_abiertas %}
                    <tr class="incident-row" data-incident="{{ solicitud.id }}">
                        <td class="request-incident-type">{{ solicitud.incident_type }}</td>
                        <td class="request-brigade-name">{{ solicitud.brigade_name }}</td>
                        <td class="request-state">{{ solicitud.request_state }}</td>
                        <td class="request-date">{{ solicitud.request_delivery }}</td>
                        <td class="text-end" style="white-space: nowrap;">
                            <a href="{% url 'management_view' solicitud.id %}" 
                                class="btn btn-sm btn-secondary me-2 mb-2 w-sm-auto mb-sm-0 btn-ver" title="Ver Encuesta">
                                <i class="fas fa-eye fa-lg me-1"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    
        <!-- Segunda tabla: Cuadrillas más efectivas -->
        <div class="card shadow col-md-6">
            <div class="card-header">
                <h5 class="m-0 font-weight-bold text-primary">Cuadrillas Más Efectivas por mes en 2024</h5>
            </div>
            <form method="GET" action="{% url 'dirección_main' %}">
                <div class="form-group">
                    <label for="month"class="m-0 font-weight-bold text-primary">Selecciona un mes:</label>
                    <select id="month" name="month" class="form-control" onchange="this.form.submit()">
                        <option value="">Seleccionar...</option>
                        {% for mes in meses %}
                        <option value="{{ mes.value }}" {% if mes.value == selected_month %}selected{% endif %}>{{ mes.label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </form>
    
            <table class="table table-bordered table-compact">
                <thead>
                    <tr>
                        <th>Nombre de Cuadrilla</th>
                        <th>Total de Solicitudes Finalizadas/Cerradas</th>
                        <th>Solicitudes Finalizadas</th>
                        <th>Solicitudes Cerradas</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cuadrilla in mejores_cuadrillas %}
                    <tr>
                        <td>{{ cuadrilla.brigade_name }}</td>
                        <td>{{ cuadrilla.total_finalizadas_cerradas }}</td>
                        <td>{{ cuadrilla.total_finalizadas }}</td>
                        <td>{{ cuadrilla.total_cerradas }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <style>
        /* Estilos para hacer las tablas más compactas */
        .table-compact {
            font-size: 12px;  /* Reduce el tamaño de la fuente */
        }
    
        .table-compact th, 
        .table-compact td {
            padding: 0.3rem;  /* Reduce el padding de las celdas */
        }
    
        /* Ajusta el tamaño del botón */
        .btn-sm {
            font-size: 10px;
            padding: 0.2rem 0.5rem;
        }
    
        /* Ajuste para el selector de meses */
        .form-control {
            font-size: 12px;
            padding: 0.2rem;
        }
    
        /* Espacio entre las tablas */
        .row .col-md-7, 
        .row .col-md-5 {
            margin-bottom: 1rem;
        }
    
        /* Margen inferior para el título */
        h4 {
            margin-bottom: 0.5rem;
        }
    </style>
<br>
</br>

    <div class="row">
        <!-- Columna izquierda: Solicitudes Pendientes y Rechazadas -->
        <div class="card shadow col-lg-6 col-md-12 col-sm-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="m-0 font-weight-bold text-primary">Informe de Solicitudes</h5>
                </div>
                <div class="card-body">
                    <!-- Tabla de Incidencias Pendientes -->
                    <h6 class="text-primary">Solicitudes Pendientes</h6>
                    <div style="max-height: 230px; overflow-y: auto; margin-bottom: 10px;">
                        <table class="table table-bordered table-compact">
                            <thead>
                                <tr>
                                    <th>Título</th>
                                    <th class="text-center">Fecha de Creación</th>
                                    <th class="text-center">Días</th>
                                    <th class="text-center">Estado</th>
                                    <th class="text-center">Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for incidencia_info in incidencias_por_fecha %}
                                    <tr>
                                        <td>{{ incidencia_info.incidencia.poll.name }}</td>
                                        <td class="text-center">{{ incidencia_info.fecha_formateada }}</td>
                                        <td class="text-center">{{ incidencia_info.dias_atraso }}</td>
                                        <td class="text-center">{{ incidencia_info.incidencia.request_state }}</td>
                                        <td class="text-center">
                                            <a href="{% url 'management_view' incidencia_info.incidencia.id %}" class="btn btn-sm btn-primary">Ver</a>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center">No hay incidencias atrasadas.</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <br>
                    </br>
                    <!-- Tabla de Solicitudes Rechazadas -->
                    <h6 class="text-primary">Solicitudes Rechazadas</h6>
                    <div style="max-height: 230px; overflow-y: auto;">
                        <table class="table table-bordered table-compact">
                            <thead>
                                <tr>
                                    <th>Título</th>
                                    <th class="text-center">Rechazado el</th>
                                    <th class="text-center">Días</th>
                                    <th class="text-center">Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pe in solicitudes_rechazadas %}
                                    <tr>
                                        <td>{{ pe.poll.name }}</td>
                                        <td class="text-center">{{ pe.updated|date:"d-m-Y" }}</td>
                                        <td class="text-center">{{ pe.dias_atraso }}</td>
                                        <td class="text-center">
                                            <a href="{% url 'management_view' pe.id %}" class="btn btn-sm btn-primary">Ver</a>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center">No hay solicitudes rechazadas.</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>                
            </div>
        </div>
    
        <!-- Columna derecha: Gráfico -->
        <div class="card shadow col-lg-6 col-md-12 col-sm-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="m-0 font-weight-bold text-primary">Gráfico de Incidencias más derivadas y en proceso</h5>
                    <button type="button" class="btn btn-link" data-toggle="modal" data-target="#detallesModal">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>                
                <div class="card-body">
                    <!-- Selector de estado -->
                    <select id="estadoSelectorIncidencias" class="btn btn-sm btn-primary" onchange="updateIncidenciasChart()">
                        <option class="btn btn-sm btn-primary" value="Derivadas">Incidencias más derivadas</option>
                        <option class="btn btn-sm btn-primary" value="Proceso">Incidencias en proceso</option>
                    </select>
                    <canvas id="incidenciasChart" width="400" height="200"></canvas>
                    <!-- Gráfico de cuadrillas atrasadas -->
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="m-0 font-weight-bold text-primary">Gráfico de cuadrillas atrasadas</h5>
                        <button type="button" class="btn btn-link" data-toggle="modal" data-target="#detallesModalCuadrilla">
                            <i class="fas fa-eye"></i> 
                        </button>
                    </div>
                    <!-- Selector de estado -->
                    <select id="estadoSelector" class="btn btn-sm btn-primary" onchange="updateChart()">
                        <option class="btn btn-sm btn-primary" value="Derivadas">Derivadas</option>
                        <option class="btn btn-sm btn-primary" value="Iniciadas">Iniciadas</option>
                        <option class="btn btn-sm btn-primary" value="En Proceso">En Proceso</option>
                    </select>
                    <canvas id="cuadrillasAtrasadasChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

<!-- Modal -->
<div class="modal fade" id="detallesModal" tabindex="-1" role="dialog" aria-labelledby="detallesModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detallesModalLabel">Detalles de las Incidencias</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <h6>Incidencias más derivadas:</h6>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Incidencia</th>
                            <th>Cantidad Derivadas</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in incidencias_derivadas %}
                        <tr>
                            <td>{{ item.nombre }}</td>
                            <td>{{ item.count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <h6>Incidencias en proceso:</h6>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Incidencia</th>
                            <th>Cantidad en Proceso</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in incidencias_en_proceso %}
                        <tr>
                            <td>{{ item.nombre }}</td>
                            <td>{{ item.count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>


<!-- Modal -->
<div class="modal fade" id="detallesModalCuadrilla" tabindex="-1" role="dialog" aria-labelledby="detallesModalLabelCuadrilla" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detallesModalLabelCuadrilla">Detalles de Cuadrillas Atrasadas</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Cuadrilla</th>
                            <th>Total Atrasadas</th>
                            <th>Total Derivadas</th>
                            <th>Total Iniciadas</th>
                            <th>Total en Proceso</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cuadrilla in cuadrillas_atrasadas %}
                        <tr>
                            <td>{{ cuadrilla.brigade__user__first_name }} {{ cuadrilla.brigade__user__last_name }}</td>
                            <td>{{ cuadrilla.total_atrasadas }}</td>
                            <td>{{ cuadrilla.total_derivadas }}</td>
                            <td>{{ cuadrilla.total_iniciadas }}</td>
                            <td>{{ cuadrilla.total_procesos }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>


    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        var ctx = document.getElementById('cuadrillasAtrasadasChart').getContext('2d');
    
        // Datos para cada estado
        var dataDerivadas = {{ totals_derivadas|safe }};
        var dataIniciadas = {{ totals_iniciadas|safe }};
        var dataProcesos = {{ totals_procesos|safe }};
        var labels = {{ nombres|safe }};
    
        // Configuración inicial del gráfico (muestra Derivadas por defecto)
        var chartData = {
            labels: labels,
            datasets: [{
                label: 'Derivadas',
                data: dataDerivadas,
                backgroundColor: 'rgba(54, 162, 235, 0.2)',  // Color azul para Derivadas
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        };
    
        // Crear el gráfico
        var cuadrillasAtrasadasChart = new Chart(ctx, {
            type: 'bar',
            data: chartData,
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    
        // Función para actualizar el gráfico según el estado seleccionado
        function updateChart() {
            var selectedState = document.getElementById('estadoSelector').value;
    
            // Actualizar los datos y la etiqueta del gráfico según el estado seleccionado
            if (selectedState === "Derivadas") {
                cuadrillasAtrasadasChart.data.datasets[0].label = 'Derivadas';
                cuadrillasAtrasadasChart.data.datasets[0].data = dataDerivadas;
                cuadrillasAtrasadasChart.data.datasets[0].backgroundColor = 'rgba(54, 162, 235, 0.2)';  // Azul para Derivadas
                cuadrillasAtrasadasChart.data.datasets[0].borderColor = 'rgba(54, 162, 235, 1)';
            } else if (selectedState === "Iniciadas") {
                cuadrillasAtrasadasChart.data.datasets[0].label = 'Iniciadas';
                cuadrillasAtrasadasChart.data.datasets[0].data = dataIniciadas;
                cuadrillasAtrasadasChart.data.datasets[0].backgroundColor = 'rgba(255, 99, 132, 0.2)';  // Rojo para Iniciadas
                cuadrillasAtrasadasChart.data.datasets[0].borderColor = 'rgba(255, 99, 132, 1)';
            } else if (selectedState === "En Proceso") {
                cuadrillasAtrasadasChart.data.datasets[0].label = 'En Proceso';
                cuadrillasAtrasadasChart.data.datasets[0].data = dataProcesos;
                cuadrillasAtrasadasChart.data.datasets[0].backgroundColor = 'rgba(255, 206, 86, 0.2)';  // Amarillo para En Proceso
                cuadrillasAtrasadasChart.data.datasets[0].borderColor = 'rgba(255, 206, 86, 1)';
            }
    
            // Actualizar el gráfico para reflejar los nuevos datos
            cuadrillasAtrasadasChart.update();
        }
    </script>
    
        <!-- Fila del gráfico -->
        <div class="row mt-4">
            <div class="card shadow col-6">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="m-0 font-weight-bold text-primary">Gráfico de Incidencias Más Frecuentes</h5>
                    <button type="button" class="btn btn-link" data-toggle="modal" data-target="#detallesModalIncident">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <canvas id="incidentChart" width="400" height="200"></canvas>
            </div>
            <div class="card shadow col-6">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="m-0 font-weight-bold text-primary"> Gráfico de Solicitudes Resueltas Últimos 6 Meses</h5>
                    <button type="button" class="btn btn-link" data-bs-toggle="modal" data-bs-target="#dataModal">
                        <i class="fas fa-eye"></i> <!-- Ícono de ojo -->
                    </button>
                </div>
                </h4>
                <canvas id="solicitudesGrafico" width="400" height="200"></canvas>
            </div>   
        </div>

<!-- Modal -->
<div class="modal fade" id="detallesModalIncident" tabindex="-1" role="dialog" aria-labelledby="detallesModalLabelIncident" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detallesModalLabelIncident">Detalles de Incidencias Más Frecuentes</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Incidencia</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for incident in top_incidents %}
                        <tr>
                            <td>{{ incident.incident__name }}</td>
                            <td>{{ incident.total }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

    <!-- Modal para mostrar la tabla -->
    <div class="modal fade" id="dataModal" tabindex="-1" aria-labelledby="dataModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title" id="dataModalLabel">Detalles de Solicitudes Resueltas</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            <table class="table table-striped">
                <thead>
                <tr>
                    <th>Mes</th>
                    <th>Solicitudes Finalizadas</th>
                    <th>Solicitudes Cerradas</th>
                    <th>Total</th>
                </tr>
                </thead>
                <tbody>
                {% for fecha, finalizadas, cerradas, total in tabla_datos %}
                <tr>
                    <td>{{ fecha }}</td>
                    <td>{{ finalizadas }}</td>
                    <td>{{ cerradas }}</td>
                    <td>{{ total }}</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
        </div>
    </div>
  
        
    
        <style>
            .incident-row {
                cursor: pointer;
            }
    
            @media (max-width: 992px) {
                .col-md-6 {
                    margin-bottom: 20px; /* Espacio entre las dos columnas en pantallas más pequeñas */
                }
            }
        </style>

    <br>
    </br>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container {
            display: flex; /* Utiliza Flexbox para alinear los gráficos */
            justify-content: space-between; /* Espacio entre los gráficos */
            margin: 20px 0; /* Margen superior e inferior */
        }
        canvas {
            max-width: 400px; /* Ancho máximo de los gráficos */
            width: 100%; /* Ancho completo dentro del contenedor */
            height: 200px; /* Altura fija para los gráficos */
        }
    </style>
    
    
    <script>
        var ctx = document.getElementById('incidenciasChart').getContext('2d');
    
        // Datos para cada estado
        var dataDerivadas = {{ derivadas_count|safe }};
        var dataProceso = {{ proceso_count|safe }};
        var labels = {{ incidencias_nombres|safe }};
    
        // Configuración inicial del gráfico (muestra "Derivadas" por defecto)
        var chartData = {
            labels: labels,
            datasets: [{
                label: 'Incidencias más derivadas',
                data: dataDerivadas,
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        };
    
        // Crear el gráfico
        var incidenciasChart = new Chart(ctx, {
            type: 'bar',
            data: chartData,
            options: {
                scales: {
                    x: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Incidencias'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Cantidad'
                        }
                    }
                }
            }
        });
    
        // Función para actualizar el gráfico según el estado seleccionado
        function updateIncidenciasChart() {
            var selectedState = document.getElementById('estadoSelectorIncidencias').value;
    
            // Actualizar los datos y la etiqueta del gráfico según el estado seleccionado
            if (selectedState === "Derivadas") {
                incidenciasChart.data.datasets[0].label = 'Incidencias más derivadas';
                incidenciasChart.data.datasets[0].data = dataDerivadas;
                incidenciasChart.data.datasets[0].backgroundColor = 'rgba(75, 192, 192, 0.2)';
                incidenciasChart.data.datasets[0].borderColor = 'rgba(75, 192, 192, 1)';
            } else if (selectedState === "Proceso") {
                incidenciasChart.data.datasets[0].label = 'Incidencias en proceso';
                incidenciasChart.data.datasets[0].data = dataProceso;
                incidenciasChart.data.datasets[0].backgroundColor = 'rgba(255, 159, 64, 0.2)';
                incidenciasChart.data.datasets[0].borderColor = 'rgba(255, 159, 64, 1)';
            }
    
            // Actualizar el gráfico para reflejar los nuevos datos
            incidenciasChart.update();
        }
    </script>

    <!-- maps-->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Georeferencia de Municipalidad</h5>
            </div>
            <div class="card-body">
                <iframe
                    src="{{kepler_url}}"
                    width="100%" height="500px" style="border:0;" allowfullscreen="" loading="lazy"
                    referrerpolicy="no-referrer-when-downgrade"></iframe>
            </div>
        </div>
    </div>

</div>
</div>
<style>
    .col-auto {
    position: absolute;
    bottom: 10px;
    right: 10px;
}
</style>
<!-- fin main -->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    var ctx = document.getElementById('incidentChart').getContext('2d');
    var incidentChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{ incident_names|safe }},  // Los nombres de las incidencias
            datasets: [{
                label: 'Incidencias más frecuentes',
                data: {{ incident_totals|safe }},  // Los totales de las incidencias
                backgroundColor: [
                    'rgba(75, 192, 192, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(255, 206, 86, 0.2)',
                    'rgba(153, 102, 255, 0.2)',
                    'rgba(255, 159, 64, 0.2)'
                ],
                borderColor: [
                    'rgba(75, 192, 192, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>

<script>
    var ctx = document.getElementById('solicitudesGrafico').getContext('2d');
    var solicitudesGrafico = new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ fechas|safe }},  // Meses en las etiquetas
            datasets: [
                {
                    label: 'Finalizadas',
                    data: {{ finalizadas_data|safe }},
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    fill: true,
                    tension: 0.1,
                },
                {
                    label: 'Cerradas',
                    data: {{ cerradas_data|safe }},
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    fill: true,
                    tension: 0.1,
                },
                {
                    label: 'Total (Finalizadas + Cerradas)',
                    data: {{ total_data|safe }},
                    borderColor: 'rgba(153, 102, 255, 1)',
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    fill: true,
                    tension: 0.1,
                }
            ]
        },
        options: {
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Meses'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Número de Solicitudes'
                    },
                    beginAtZero: true
                }
            }
        }
    });
</script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" >
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Llamada del footer -->
{% include 'core/footer.html' %}

</div>

</div>

<script src="{% static '/registration/vendor/jquery-easing/jquery.easing.min.js' %}"></script>

<script src="{% static '/registration/vendor/chart.js/Chart.min.js' %}"></script>

<script src="{% static '/registration/js/demo/chart-area-demo.js' %}"></script>
<script src="{% static '/registration/js/demo/chart-pie-demo.js' %}"></script>

</body>

</html>
{% endblock %}